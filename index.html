<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>danmu</title>
    </head>

    <body>
        <div id="message"></div>
        <div id="enter" class="enter-container"></div>
    </body>
</html>

<style type="text/css">
    html {
        background: #000;
    }

    body {
        margin-top: 8px;
        /* font-family: Renogare, "Mi Sans Medium", "微软雅黑"; */
        font-family: "Microsoft YaHei", "Microsoft Sans Serif", "Microsoft SanSerf", "微软雅黑";
        font-size: 14px;
        color: #fefefe;
        position: relative;
    }

    #message {
        width: 100%;
        height: calc(100vh - 40px);
        overflow-y: hidden;
    }

    #message:hover,
    #enter:hover {
        outline: 4px solid red;
    }

    .usr {
        color: rgb(117, 122, 129);
    }

    .msg {
        padding-left: 3px;
    }

    .enter {
        color: #8cd918;
        font-size: 14px;
    }

    #enter {
        width: calc(100% - 16px);
    }

    .gift-gold {
        color: #edd400;
    }

    .enter-container {
        margin-bottom: 8px;
        position: fixed;
        bottom: 0;
    }

    .medal {
        display: inline-block;
        font-size: 11px;
        border: 1px solid transparent;
        border-radius: 2px;
        margin-right: 4px;
        line-height: 14px;
    }

    .medal-label,
    .medal-level {
        justify-content: center;
        align-items: center;
        min-width: 12px;
        padding: 0 3px;
        color: #fff;
        border-radius: 1px;

        box-sizing: content-box;
        height: 100%;
        text-align: center;
    }

    .line {
        margin-top: 2px;
        margin-bottom: 2px;
    }

    .admin {
        padding: 0 2px;
        height: 14px;
        color: rgb(219, 135, 0);
        border: 1px solid rgb(219, 135, 0);
        border-radius: 2px;
        line-height: 14px;
        font-size: 11px;
        margin-right: 4px;
    }
</style>

<script src="https://cdn.bootcdn.net/ajax/libs/pako/0.1.0/pako.min.js"></script>
<script type="text/javascript">
    var ws = new WebSocket("wss://broadcastlv.chat.bilibili.com/sub");

    var room_id = 3253817;
    var json = {
        uid: 0,
        roomid: room_id,
        protover: 1,
        platform: "web",
        clientver: "1.4.0",
    };

    ws.onopen = () => {
        console.log("WebSocket 已连接上");
        ws.send(getCertification(JSON.stringify(json)).buffer);
    };

    function getCertification(json) {
        var bytes = str2bytes(json);
        var n1 = new ArrayBuffer(bytes.length + 16);
        var i = new DataView(n1);
        i.setUint32(0, bytes.length + 16), i.setUint16(4, 16), i.setUint16(6, 1), i.setUint32(8, 7), i.setUint32(12, 1);
        for (var r = 0; r < bytes.length; r++) {
            i.setUint8(16 + r, bytes[r]);
        }
        return i;
    }

    function str2bytes(str) {
        const bytes = [];
        let c;
        const len = str.length;
        for (let i = 0; i < len; i++) {
            c = str.charCodeAt(i);
            if (c >= 0x010000 && c <= 0x10ffff) {
                bytes.push(((c >> 18) & 0x07) | 0xf0);
                bytes.push(((c >> 12) & 0x3f) | 0x80);
                bytes.push(((c >> 6) & 0x3f) | 0x80);
                bytes.push((c & 0x3f) | 0x80);
            } else if (c >= 0x000800 && c <= 0x00ffff) {
                bytes.push(((c >> 12) & 0x0f) | 0xe0);
                bytes.push(((c >> 6) & 0x3f) | 0x80);
                bytes.push((c & 0x3f) | 0x80);
            } else if (c >= 0x000080 && c <= 0x0007ff) {
                bytes.push(((c >> 6) & 0x1f) | 0xc0);
                bytes.push((c & 0x3f) | 0x80);
            } else {
                bytes.push(c & 0xff);
            }
        }
        return bytes;
    }

    ws.onopen = function () {
        console.log("WebSocket 已连接上");
        ws.send(getCertification(JSON.stringify(json)).buffer);
        timer = setInterval(function () {
            var n1 = new ArrayBuffer(16);
            var i = new DataView(n1);
            i.setUint32(0, 0), i.setUint16(4, 16), i.setUint16(6, 1), i.setUint32(8, 2), i.setUint32(12, 1);
            ws.send(i.buffer);
        }, 30000);
    };

    ws.onclose = function () {
        console.log("连接已关闭");
        if (timer != null) clearInterval(timer);
    };

    function medal(data, is_msg) {
        if (data.length != 0) {
            if (is_msg && data[11]) {
                let color = parseInt(data[4]).toString(16);
                return `<span class="medal" style="background-color: #${color};"><span class="medal-label" style="color: #FFFFFF;">${data[1]}</span><span class="medal-level" style="color: #${color}; background-color: #FFFFFF;">${data[0]}</span></span>`;
            }
        }

        return "";
    }

    function admin(is_admin) {
        if (is_admin) {
            return `<span class="admin">房</span>`;
        }

        return "";
    }

    function rank_icon(rank) {
        if (rank == 1) {
            return `<i style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAgCAMAAABjCgsuAAABmFBMVEX/gWb/cWz/cGwAAAD/cWz/S4r/l07/S4r/mE7/UpL/Sov/mE3/fmD/////a2//bW3/2Nv/cWv/eGX/emT/X3n/ZHX/anH/c2n/aHL/fGL/iVj/gF//g1z/VIL/W3z/ZnP/b2z/VoH/WX7/hVv/i1b/3Nn/UYT/hlr/h1n/d2b/gV7/XXv/klH/WH//dGj/e2P/gl3/TYj/YXf/dmf/dWf/T4b/jFX/j1L/2tv/XXr/YXj/lE7/V3//jlT/Y3f/YnX/x8L/xLn/1df/ycv/vsD/wbz/srn/y8b/s67/t6v/uqf/gWn/jFT/2N3/ztX/0ND/w8X/ucX/r6//oaz/jpD/koX/YYH/ioD/ZoD/fnD/087/xMz/ycf/ub3/rrv/u7f/pbb/l5n/lJD/eoD/hHn/d3P/c3L/dm3/1dn/ytD/xsn/tLv/xrb/s7T/rbH/p6v/kpz/pJn/eon/cob/fnv/g3H/7Ov/vcb/rqP/lKP/foT/b33/d3n/bXL/e2z/8/P/uL//vrn/oKT/iJn/bo3/iYP/bYP/aXqKkCEdAAAADHRSTlMc5qYA7ebmpqYc7e2SzZU0AAADJklEQVQ4y33TV1taQRAG4LFrIrJg7ygeBWwELGgiSNWEgCBdmjSxxN5revK3M7vLWdGL7PU73zNnzgzUtTQ1vKNvfn58fHxwcHBk5MP09Ojo0NDk5FJHx/KyydbZOTw83NPT1VVTC3XQ8oZz7pGPyHwSuclkRc95W1ubsh6gSfBBHi84jX/JlRpNLTSIbgRHv7TE4zvR93CvRK9S1QDqF3xUcCvjw88cfXc3cM84esFfNS/zmTmQOcZHf8X5aP6cv+ZKzmfm5oBxPsptfzBK038m/WdslMhF89zr9VA1+W1fMB7PZDIHfnLt8XiOWXz+q0KxSTmmm/V6NQgejdKCcz+Rn+sRuzlU4FtX0XSzWa1ubwf5W6OZYNK3F9wOhfzEE0oT53HuEbtRsAKMx3T0s7OA8exHxa99Pow9ODtzkaO7NEnfFWjzCsUVFqBX6zF+trcVxNrchpIkGfI4HLtk10GIw7FxgaO8Cn/HAjOmU97b2gpi8svne2T//oQ4nPtO537Kadm4wG8tdbsVio96mbf2A+PoTbZb7MhzQpyFcGAj/JDDAvattEDwfgNMUm4y2ax/vxFacXQczjkth+H8erbMRskKZivcYIQOectOsPOAw0Us/EmSFKOTV9uxgMcbjMaBAZDX5j5A0sR1kEsFsPtV+taK7FtpAYs3otdqAbtha1PYCxwR146yVMpK7t+xWCySYJOnBZ8w3YDp2omJCbBZ+Zb1HP7YtLh2NJodt8TeVpHy3l5awLrRotfpQJxI4YEVqPKSlMJ+pK1L/K/4sbTAMMDidX19fVC1xFhQUhVXpWwikTiV1i75KL9gAeXMj41B1YlsWtzlPEbHniIRu2T3osfmWYG2whcWoGrn1yV3Ef2pPiLhY6MxGFgB5dyvQNXB3qSy5dO1iFrtta/ab7zUy83rKnxlEaoOtpx4Musv6dp4vV4+eeRawT+vLC5OgeDdM2Z+ImJtqvkYcuqnQBwseraU6PnaCN4nc/TvoUYjDpbGi3QWr3tunmr0jVCLHL04EeFfN48aXzNAPeP/aZ5z7t8C1EFtTeW+q9LRi+afeWMz1P0DSpf/JHLD0fkAAAAASUVORK5CYII=);"></i>`;
        }
    }

    ws.onmessage = function (evt) {
        var blob = evt.data;
        decode(blob, function (packet) {
            if (packet.op == 5) {
                for (let i = 0; i < packet.body.length; i++) {
                    var element = packet.body[i];
                    console.log(element);

                    if (element.cmd == "DANMU_MSG") {
                        // 弹幕
                        document
                            .getElementById("message")
                            .insertAdjacentHTML(
                                "afterbegin",
                                `<div class="line">${medal(element.info[3], true)}${admin(
                                    element.info[2][2]
                                )}<span class="usr">${element.info[2][1]}: </span><span class="msg">${
                                    element.info[1]
                                }</span></div>`
                            );
                    } else if (element.cmd == "INTERACT_WORD") {
                        // 进入直播间
                        document.getElementById(
                            "enter"
                        ).innerHTML = `<div><span class="enter">${element.data.uname} 进入直播间</span></div>`;
                    } else if (element.cmd == "SEND_GIFT") {
                        // 礼物
                        if (element.data.coin_type == "gold") {
                            document
                                .getElementById("message")
                                .insertAdjacentHTML(
                                    "afterbegin",
                                    `<div class="line"><span class="gift-gold">感谢 ${element.data.uname} ${element.data.action}的 ${element.data.num} × ${element.data.giftName}</span></div>`
                                );
                        } else {
                            document
                                .getElementById("message")
                                .insertAdjacentHTML(
                                    "afterbegin",
                                    `<div class="line"><span class="usr">${element.data.uname}: </span><span class="msg">${element.data.num} × ${element.data.giftName}</span></div>`
                                );
                        }
                    }
                }
            }
        });
    };

    var textDecoder = new TextDecoder("utf-8");
    const readInt = function (buffer, start, len) {
        let result = 0;
        for (let i = len - 1; i >= 0; i--) {
            result += Math.pow(256, len - i - 1) * buffer[start + i];
        }
        return result;
    };

    function decode(blob, call) {
        let reader = new FileReader();
        reader.onload = function (e) {
            let buffer = new Uint8Array(e.target.result);
            let result = {};
            result.packetLen = readInt(buffer, 0, 4);
            result.headerLen = readInt(buffer, 4, 2);
            result.ver = readInt(buffer, 6, 2);
            result.op = readInt(buffer, 8, 4);
            result.seq = readInt(buffer, 12, 4);
            if (result.op == 5) {
                result.body = [];
                let offset = 0;
                while (offset < buffer.length) {
                    let packetLen = readInt(buffer, offset + 0, 4);
                    let headerLen = 16;
                    let data = buffer.slice(offset + headerLen, offset + packetLen);

                    let body = "{}";
                    if (result.ver == 2) {
                        body = textDecoder.decode(pako.inflate(data));
                    } else {
                        body = textDecoder.decode(data);
                    }
                    if (body) {
                        const group = body.split(/[\x00-\x1f]+/);
                        group.forEach((item) => {
                            try {
                                result.body.push(JSON.parse(item));
                            } catch (e) {}
                        });
                    }
                    offset += packetLen;
                }
            }
            call(result);
        };
        reader.readAsArrayBuffer(blob);
    }
</script>
